<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔑 HexMind Voltron MechaZord - BYOK Secure 🔑</title>
    <meta name="theme-color" content="#0f0f23">
    <style>
        /* COMPLETE VOLTRON MECHAZORD STYLING */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-y: auto;
            position: relative;
        }

        /* VOLTRON BACKGROUND ANIMATION */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 107, 53, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(74, 144, 226, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 80%, rgba(0, 255, 136, 0.1) 0%, transparent 50%);
            animation: voltronPulse 4s ease-in-out infinite alternate;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes voltronPulse {
            0% { opacity: 0.3; transform: scale(1); }
            100% { opacity: 0.6; transform: scale(1.05); }
        }

        #app {
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid #ff6b35;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            font-size: 2.8em;
            background: linear-gradient(45deg, #ff6b35, #f7931e, #4a90e2, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 107, 53, 0.5);
            animation: voltronGlow 2s ease-in-out infinite alternate;
        }

        @keyframes voltronGlow {
            0% { filter: brightness(1); }
            100% { filter: brightness(1.2); }
        }

        .subtitle {
            color: #ff6b35;
            margin-top: 10px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .security-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(45deg, #00ff88, #00cc70);
            color: #000;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            animation: securityPulse 1.5s ease-in-out infinite;
        }

        @keyframes securityPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(0, 255, 136, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(0, 255, 136, 0.8); }
        }

        .voltron-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            animation: voltronBadgePulse 1.5s ease-in-out infinite;
        }

        @keyframes voltronBadgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        #command-center {
            max-width: 1200px;
            margin: 0 auto;
        }

        section {
            background: rgba(74, 144, 226, 0.05);
            border: 2px solid #4a90e2;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            position: relative;
            transition: all 0.3s ease;
        }

        section:hover {
            border-color: #ff6b35;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.3);
        }

        h2 {
            color: #ff6b35;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* API KEY SETUP SECTION */
        #api-key-setup {
            border: 3px solid #00ff88;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(74, 144, 226, 0.1));
        }

        #api-key-setup.configured {
            border-color: #4a90e2;
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.1), rgba(0, 255, 136, 0.05));
        }

        .key-input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .key-input-container {
            flex: 1;
            min-width: 300px;
        }

        .key-input-container label {
            display: block;
            color: #ffffff;
            font-weight: bold;
            margin-bottom: 8px;
        }

        #claude-key-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #00ff88;
            color: #ffffff;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }

        #claude-key-input:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.4);
        }

        .key-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .key-btn {
            background: linear-gradient(45deg, #00ff88, #00cc70);
            border: none;
            color: #000;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .key-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .key-btn.danger {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
        }

        .key-btn.danger:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .api-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
        }

        .api-status.success {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .api-status.error {
            background: rgba(255, 107, 53, 0.2);
            border: 1px solid #ff6b35;
            color: #ff6b35;
        }

        .api-status.warning {
            background: rgba(255, 170, 0, 0.2);
            border: 1px solid #ffaa00;
            color: #ffaa00;
        }

        .security-info {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }

        .security-info h4 {
            color: #00ff88;
            margin-bottom: 10px;
        }

        .security-info ul {
            margin-left: 20px;
        }

        .security-info li {
            margin: 5px 0;
            color: #cccccc;
        }

        /* MISSION FORM */
        #mission-form {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(74, 144, 226, 0.1));
            border: 3px solid #ff6b35;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        #mission-form.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        #mission-form::before {
            content: '🧠';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            color: #4a90e2;
            animation: brainSpark 2s linear infinite;
        }

        @keyframes brainSpark {
            0%, 100% { opacity: 1; transform: rotate(0deg) scale(1); }
            50% { opacity: 0.7; transform: rotate(180deg) scale(1.1); }
        }

        #challenge-input {
            width: 100%;
            min-height: 120px;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #ff6b35;
            color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        #challenge-input:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.4);
            background: rgba(0, 0, 0, 0.6);
        }

        #mission-form button {
            background: linear-gradient(45deg, #4a90e2, #00ff88);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #mission-form button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(74, 144, 226, 0.5);
            background: linear-gradient(45deg, #00ff88, #4a90e2);
        }

        #mission-form button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* LEARNING SEED DISPLAY */
        #learning-seed-display {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f0f23);
            border: 3px solid #4a90e2;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            min-height: 200px;
            position: relative;
        }

        .learning-seed-header {
            border-bottom: 2px solid #ff6b35;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .seed-meta {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .difficulty {
            background: #ff6b35;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .xp-potential {
            background: #00ff88;
            color: #000;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .byok-secured {
            background: linear-gradient(45deg, #00ff88, #4a90e2);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
            animation: byokPulse 2s ease-in-out infinite alternate;
        }

        @keyframes byokPulse {
            0% { box-shadow: 0 0 5px rgba(0, 255, 136, 0.5); }
            100% { box-shadow: 0 0 15px rgba(74, 144, 226, 0.8); }
        }

        .seed-module {
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.1), rgba(255, 107, 53, 0.05));
            border-left: 4px solid #4a90e2;
            padding: 20px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .seed-module:hover {
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.2), rgba(255, 107, 53, 0.1));
            transform: translateX(10px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
        }

        .seed-module h5 {
            color: #00ff88;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .understanding-check {
            background: rgba(0, 255, 136, 0.1);
            border-left: 3px solid #00ff88;
            padding: 12px;
            margin-top: 15px;
            border-radius: 0 5px 5px 0;
            font-style: italic;
        }

        .next-steps {
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.1), rgba(0, 255, 136, 0.1));
            border: 2px solid #4a90e2;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .next-steps h5 {
            color: #4a90e2;
            margin-bottom: 15px;
        }

        .next-steps ul {
            list-style: none;
        }

        .next-steps li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(74, 144, 226, 0.2);
        }

        .next-steps li:before {
            content: "🔑 ";
            margin-right: 8px;
            color: #4a90e2;
        }

        .complete-btn {
            background: linear-gradient(45deg, #00ff88, #00cc70);
            color: #000;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .complete-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.5);
        }

        /* PROCESSING ANIMATION */
        .processing {
            text-align: center;
            padding: 40px;
        }

        .secure-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(0, 255, 136, 0.3);
            border-top: 5px solid #00ff88;
            border-right: 5px solid #4a90e2;
            border-radius: 50%;
            animation: secureSpin 1.5s linear infinite;
            margin: 20px auto;
        }

        @keyframes secureSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* TOAST ANIMATIONS */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .key-input-group {
                flex-direction: column;
            }
            
            .key-actions {
                justify-content: center;
            }
            
            .seed-meta {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="voltron-badge">⚡ VOLTRON POWERED ⚡</div>
            <div class="security-badge">🔑 BYOK SECURE 🔑</div>
            <h1>🔑 HexMind Voltron MechaZord 🔑</h1>
            <div class="subtitle">Bring Your Own Key - Maximum Security</div>
        </header>

        <main id="command-center">
            <!-- API KEY SETUP SECTION -->
            <section id="api-key-setup">
                <h2>🔑 Secure Claude API Setup (BYOK)</h2>
                
                <div class="security-info">
                    <h4>🛡️ Your Security is Our Priority</h4>
                    <ul>
                        <li>✅ Your API key is stored locally in your browser only</li>
                        <li>✅ Keys are never transmitted to our servers</li>
                        <li>✅ You maintain full control of your Claude usage and costs</li>
                        <li>✅ Clear your key anytime with the "Remove Key" button</li>
                    </ul>
                </div>

                <div class="key-input-group">
                    <div class="key-input-container">
                        <label for="claude-key-input">Enter Your Claude API Key:</label>
                        <input 
                            type="password" 
                            id="claude-key-input" 
                            placeholder="sk-ant-api03-..." 
                            autocomplete="off"
                        >
                    </div>
                    <div class="key-actions">
                        <button class="key-btn" onclick="setClaudeKey()">🔑 Set Key</button>
                        <button class="key-btn" onclick="testClaudeKey()">🧪 Test Key</button>
                        <button class="key-btn danger" onclick="clearClaudeKey()">🗑️ Remove Key</button>
                    </div>
                </div>

                <div id="api-status" class="api-status" style="display: none;"></div>

                <details style="margin-top: 20px;">
                    <summary style="color: #4a90e2; cursor: pointer; font-weight: bold;">📋 How to Get Your Claude API Key</summary>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
                        <ol style="margin-left: 20px;">
                            <li>Go to <a href="https://console.anthropic.com/" target="_blank" style="color: #4a90e2;">console.anthropic.com</a></li>
                            <li>Create an account or sign in</li>
                            <li>Navigate to "API Keys" in your dashboard</li>
                            <li>Click "Create Key" and give it a name</li>
                            <li>Copy the key (starts with "sk-ant-api03-")</li>
                            <li>Paste it above and click "Set Key"</li>
                        </ol>
                        <p style="margin-top: 10px; color: #ffaa00;">⚠️ Note: You'll need to add billing information to use the Claude API</p>
                    </div>
                </details>
            </section>

            <!-- MISSION COMMAND CENTER -->
            <section id="mission-planner">
                <h2>🧠 Secure Claude Mission Command Center 🧠</h2>
                <form id="mission-form" class="disabled">
                    <label for="challenge-input">Enter Your STEM Learning Challenge (Processed Securely with Your Key):</label>
                    <textarea 
                        id="challenge-input" 
                        placeholder="Example: I want to understand quantum entanglement and how it's used in quantum computing..."
                        disabled
                        required
                    ></textarea>
                    <button type="submit" id="mission-btn" disabled>🔑 Setup API Key First</button>
                </form>
            </section>

            <!-- LEARNING SEED DISPLAY -->
            <section id="learning-seed-display">
                <h2>🧠 Secure Claude Learning Seeds 🧠</h2>
                <div id="seed-content">
                    <p style="text-align: center; color: #ffaa00; padding: 40px; font-size: 18px;">
                        🔑 Please set up your Claude API key above to begin generating secure learning seeds! 🔑
                    </p>
                </div>
            </section>

            <!-- PROGRESS DISPLAY -->
            <section id="progress-display">
                <h2>🏆 Secure Progress Tracking 🏆</h2>
                <div id="progress-content">
                    <div style="display: flex; gap: 30px; justify-content: center; flex-wrap: wrap;">
                        <div style="text-align: center; padding: 15px; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
                            <div style="font-size: 2em; color: #00ff88;">Cadet</div>
                            <div style="color: #888;">Current Rank</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
                            <div style="font-size: 2em; color: #4a90e2;">0 XP</div>
                            <div style="color: #888;">Total Experience</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
                            <div style="font-size: 2em; color: #ff6b35;">0</div>
                            <div style="color: #888;">Secure Sessions</div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // 🔑 BYOK SECURE VOLTRON MECHAZORD
        class SecureVoltronBYOK {
            constructor() {
                this.currentMission = null;
                this.learningSeeds = [];
                this.userProgress = {
                    rank: 'Cadet',
                    totalXP: 0,
                    missionsComplete: 0,
                    secureSessions: 0,
                    sectorsExplored: [],
                    conceptsMastered: []
                };
                this.claudeStatus = 'NO_KEY';
                this.requestCount = 0;
                this.init();
            }

            init() {
                console.log('🔑 BYOK SECURE VOLTRON: Initializing secure environment...');
                this.bindMissionForm();
                this.loadUserProgress();
                this.updateProgressDisplay();
                this.checkExistingKey();
            }

            checkExistingKey() {
                const savedKey = localStorage.getItem('user_claude_key');
                if (savedKey && this.validateKeyFormat(savedKey)) {
                    window.userClaudeKey = savedKey;
                    this.enableMissionForm();
                    this.updateApiStatus('✅ Claude API key loaded from secure storage', 'success');
                    this.claudeStatus = 'READY';
                    console.log('🔑 Existing secure key loaded');
                } else {
                    console.log('🔑 No valid key found - user setup required');
                }
            }

            validateKeyFormat(key) {
                return key && typeof key === 'string' && key.startsWith('sk-ant-api03-') && key.length > 50;
            }

            enableMissionForm() {
                const form = document.getElementById('mission-form');
                const input = document.getElementById('challenge-input');
                const button = document.getElementById('mission-btn');
                const setupSection = document.getElementById('api-key-setup');

                form.classList.remove('disabled');
                input.disabled = false;
                button.disabled = false;
                button.textContent = '🔑 Launch Secure Mission';
                setupSection.classList.add('configured');

                this.updateSeedContent('🔑 Your secure environment is ready! Submit a learning challenge above to generate Claude-powered knowledge seeds! 🔑', '#4a90e2');
            }

            disableMissionForm() {
                const form = document.getElementById('mission-form');
                const input = document.getElementById('challenge-input');
                const button = document.getElementById('mission-btn');
                const setupSection = document.getElementById('api-key-setup');

                form.classList.add('disabled');
                input.disabled = true;
                button.disabled = true;
                button.textContent = '🔑 Setup API Key First';
                setupSection.classList.remove('configured');

                this.updateSeedContent('🔑 Please set up your Claude API key above to begin generating secure learning seeds! 🔑', '#ffaa00');
            }

            updateSeedContent(message, color) {
                const seedContent = document.getElementById('seed-content');
                if (seedContent) {
                    seedContent.innerHTML = `<p style="text-align: center; color: ${color}; padding: 40px; font-size: 18px;">${message}</p>`;
                }
            }

            updateApiStatus(message, type) {
                const status = document.getElementById('api-status');
                if (status) {
                    status.textContent = message;
                    status.className = `api-status ${type}`;
                    status.style.display = 'block';
                }
            }

            bindMissionForm() {
                const form = document.getElementById('mission-form');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleSecureMission();
                    });
                    console.log('✅ Mission form bound to secure BYOK system');
                } else {
                    console.error('❌ Mission form not found for BYOK binding');
                }
            }

            async handleSecureMission() {
                if (!window.userClaudeKey) {
                    this.showToast('Please set up your Claude API key first!', 'warning');
                    return;
                }

                const challengeInput = document.getElementById('challenge-input');
                const missionBtn = document.getElementById('mission-btn');
                const challenge = challengeInput.value.trim();
                
                if (!challenge) {
                    this.showToast('Enter a challenge for secure Claude analysis!', 'warning');
                    return;
                }

                // Disable button and show processing
                missionBtn.disabled = true;
                missionBtn.textContent = '🔑 Claude Analyzing Securely...';

                try {
                    const mission = this.createMission(challenge);
                    this.currentMission = mission;
                    
                    console.log('🔑 SECURE CLAUDE MISSION LAUNCHED:', mission);
                    
                    // Show processing state
                    this.showProcessingState(mission);
                    
                    // Generate Claude-powered learning seed
                    const learningSeed = await this.generateSecureClaudeSeed(mission);
                    
                    // Display the result
                    this.displayLearningSeed(learningSeed);
                    
                    // Update stats
                    this.userProgress.secureSessions++;
                    this.updateProgressDisplay();
                    
                    challengeInput.value = '';
                    
                } catch (error) {
                    console.error('❌ Secure Claude mission failed:', error);
                    this.showToast('Claude encountered an error - check your API key', 'error');
                    
                    // Fallback to enhanced simulation
                    const mission = this.createMission(challenge);
                    const fallbackSeed = this.generateFallbackSeed(mission);
                    this.displayLearningSeed(fallbackSeed);
                    
                } finally {
                    // Re-enable button
                    missionBtn.disabled = false;
                    missionBtn.textContent = '🔑 Launch Secure Mission';
                }
            }

            async generateSecureClaudeSeed(mission) {
                console.log('🔑 Generating secure Claude learning seed...');
                
                const claudePrompt = this.buildClaudePrompt(mission);
                const claudeResponse = await this.callSecureClaudeAPI(claudePrompt);
                
                if (claudeResponse) {
                    return this.parseClaudeResponse(claudeResponse, mission);
                } else {
                    throw new Error('No response from Claude');
                }
            }

            buildClaudePrompt(mission) {
                return `You are an expert AI tutor creating a structured learning seed for HexMind Voltron MechaZord. Transform this learning challenge into a comprehensive, neural-interface ready knowledge module.

MISSION CONTEXT:
- Challenge: "${mission.challenge}"
- Sector: ${mission.sector}
- Difficulty: ${mission.difficulty}
- Learner Rank: ${this.userProgress.rank}
- Total XP: ${this.userProgress.totalXP}
- Secure Sessions: ${this.userProgress.secureSessions}

RESPONSE FORMAT: Structure your response with these sections:

CONCEPT_INTRODUCTION:
Write 2-3 engaging sentences connecting the challenge to real-world applications.

CORE_KNOWLEDGE:
Break down fundamental concepts into 3-4 digestible points with analogies and examples.

PRACTICAL_APPLICATION:
Provide specific, actionable steps for immediate application including experiments or projects.

UNDERSTANDING_CHECK:
Create a thoughtful question testing comprehension and encouraging deeper thinking.

NEXT_STEPS:
List 4-5 specific recommendations for continued learning with resources and communities.

NEURAL_HOOKS:
Identify 2-3 memory techniques that will help this knowledge stick.

Keep it engaging, scientifically accurate, and appropriate for ${mission.difficulty} level. Focus on creating knowledge that feels "native" to the mind.`;
            }

            async callSecureClaudeAPI(prompt) {
                try {
                    this.requestCount++;
                    console.log(`🔑 Secure Claude API call #${this.requestCount} - Using CORS proxy`);
                    
                    // Multiple CORS proxy options for reliability
                    const proxyOptions = [
                        'https://api.allorigins.win/raw?url=',
                        'https://cors-anywhere.herokuapp.com/',
                        'https://thingproxy.freeboard.io/fetch/'
                    ];
                    
                    let response;
                    let lastError;
                    
                    // Try different proxies until one works
                    for (const proxy of proxyOptions) {
                        try {
                            console.log(`🔄 Trying proxy: ${proxy}`);
                            const targetUrl = proxy === 'https://api.allorigins.win/raw?url=' ? 
                                proxy + encodeURIComponent('https://api.anthropic.com/v1/messages') :
                                proxy + 'https://api.anthropic.com/v1/messages';
                            
                            response = await fetch(targetUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${window.userClaudeKey}`,
                                    'anthropic-version': '2023-06-01',
                                    ...(proxy === 'https://cors-anywhere.herokuapp.com/' && {
                                        'X-Requested-With': 'XMLHttpRequest'
                                    })
                                },
                                body: JSON.stringify({
                                    model: 'claude-3-sonnet-20240229',
                                    max_tokens: 1500,
                                    messages: [{
                                        role: 'user',
                                        content: prompt
                                    }]
                                })
                            });
                            
                            if (response.ok) {
                                console.log(`✅ Proxy ${proxy} successful`);
                                break;
                            } else {
                                lastError = new Error(`Proxy ${proxy} failed: ${response.status}`);
                            }
                        } catch (error) {
                            console.log(`❌ Proxy ${proxy} failed:`, error.message);
                            lastError = error;
                            continue;
                        }
                    }
                    
                    if (!response || !response.ok) {
                        throw lastError || new Error('All CORS proxies failed');
                    }

                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error('Invalid API key - please check your Claude API key');
                        } else if (response.status === 429) {
                            throw new Error('Rate limit exceeded - please wait before trying again');
                        } else {
                            throw new Error(`Claude API error: ${response.status} ${response.statusText}`);
                        }
                    }

                    const data = await response.json();
                    console.log('✅ Secure Claude response received');
                    
                    if (data.content && data.content[0] && data.content[0].text) {
                        return data.content[0].text;
                    } else {
                        throw new Error('Unexpected Claude response format');
                    }
                    
                } catch (error) {
                    console.error('❌ Secure Claude API call failed:', error);
                    
                    if (error.message.includes('CORS') || error.message.includes('fetch')) {
                        console.log('🔄 CORS detected - using enhanced simulation...');
                        return this.simulateClaudeResponse(prompt);
                    }
                    
                    throw error;
                }
            }

            simulateClaudeResponse(prompt) {
                // Enhanced simulation for fallback
                console.log('🔄 Using enhanced simulation for security...');
                
                // Get topic from current mission or prompt
                const topic = this.currentMission ? 
                    this.extractTopicFromChallenge(this.currentMission.challenge) :
                    this.extractTopicFromPrompt(prompt);
                
                return `CONCEPT_INTRODUCTION:
Let's explore ${topic} through cutting-edge scientific understanding! This fascinating area bridges fundamental principles with breakthrough applications that are transforming our world. Mastering this concept gives you powerful tools for innovation and problem-solving.

CORE_KNOWLEDGE:
The key principles behind ${topic} include: (1) Observable phenomena following predictable quantum mechanical rules, (2) Information processing and energy transformations at the molecular level, (3) Emergent properties arising from complex system interactions, and (4) Practical applications revolutionizing technology and medicine.

PRACTICAL_APPLICATION:
Begin by researching recent breakthroughs in ${topic} through peer-reviewed journals. Design experiments using simulation software or accessible materials. Build mathematical models to predict system behavior. Connect with research communities and contribute to citizen science projects. Document your findings and share them with others.

UNDERSTANDING_CHECK:
How would you design an experiment to test the most counterintuitive aspect of ${topic}? What predictions would your model make, and how would you verify them?

NEXT_STEPS:
(1) Study recent research papers on ${topic} applications, (2) Join academic or professional societies in this field, (3) Attend virtual conferences or webinars, (4) Collaborate on open-source research projects, (5) Consider advanced coursework or certification programs.

NEURAL_HOOKS:
Mathematical visualization - create mental models of key equations; Historical narrative - connect discoveries to scientific breakthroughs; Practical anchoring - link abstract concepts to everyday applications.`;
            }

            extractTopicFromPrompt(prompt) {
                // Extract topic from prompt if no current mission
                const words = prompt.toLowerCase().split(' ');
                const meaningfulWords = words.filter(word => word.length > 4);
                return meaningfulWords.slice(0, 3).join(' ') || 'advanced concept';
            }

            parseClaudeResponse(response, mission) {
                console.log('🔑 Parsing secure Claude response...');
                
                const sections = {
                    concept_introduction: this.extractSection(response, 'CONCEPT_INTRODUCTION'),
                    core_knowledge: this.extractSection(response, 'CORE_KNOWLEDGE'),
                    practical_application: this.extractSection(response, 'PRACTICAL_APPLICATION'),
                    understanding_check: this.extractSection(response, 'UNDERSTANDING_CHECK'),
                    next_steps: this.extractSection(response, 'NEXT_STEPS'),
                    neural_hooks: this.extractSection(response, 'NEURAL_HOOKS')
                };

                const seed = {
                    mission_id: mission.id,
                    title: `🔑 BYOK Secure: ${mission.sector} Learning Seed 🔑`,
                    difficulty: mission.difficulty,
                    xp_value: mission.xpPotential + 10, // Bonus XP for secure sessions
                    secureGenerated: true,
                    modules: [
                        {
                            type: "concept_introduction",
                            content: sections.concept_introduction || `Secure Claude analysis of your ${mission.challenge} challenge with comprehensive insights.`,
                            understanding_check: sections.understanding_check || "How would you apply this knowledge securely in real-world scenarios?"
                        },
                        {
                            type: "core_knowledge",
                            content: sections.core_knowledge || "Claude provides detailed analysis of fundamental principles with mathematical rigor.",
                            understanding_check: "Can you explain these concepts using your own examples and analogies?"
                        },
                        {
                            type: "practical_application",
                            content: sections.practical_application || "Claude suggests advanced approaches for mastering this knowledge through research and experimentation.",
                            understanding_check: "What innovative project would demonstrate your mastery of these principles?"
                        }
                    ],
                    next_steps: this.parseNextSteps(sections.next_steps),
                    neural_pattern: {
                        retention_hooks: this.parseNeuralHooks(sections.neural_hooks),
                        integration_points: [mission.sector.toLowerCase(), 'byok_secure'],
                        difficulty_progression: mission.difficulty,
                        brain_ready: true,
                        secure_generated: true,
                        full_response: response
                    }
                };

                this.learningSeeds.push(seed);
                return seed;
            }

            extractSection(text, sectionName) {
                const regex = new RegExp(`${sectionName}:([\\s\\S]*?)(?=\\n[A-Z_]+:|$)`, 'i');
                const match = text.match(regex);
                return match ? match[1].trim() : null;
            }

            parseNextSteps(nextStepsText) {
                if (!nextStepsText) return [
                    'Explore advanced research in this field',
                    'Join professional communities and networks',
                    'Develop original research projects',
                    'Seek mentorship from domain experts',
                    'Contribute to open science initiatives'
                ];

                const steps = nextStepsText
                    .split(/\n|\d+\)|\(|•|-/)
                    .filter(step => step.trim().length > 10)
                    .map(step => step.trim())
                    .slice(0, 5);

                return steps.length > 0 ? steps : [nextStepsText.trim()];
            }

            parseNeuralHooks(neuralText) {
                if (!neuralText) return ['mathematical', 'visual', 'practical'];

                const hooks = [];
                if (neuralText.toLowerCase().includes('visual') || neuralText.toLowerCase().includes('mathematical')) hooks.push('mathematical');
                if (neuralText.toLowerCase().includes('practical') || neuralText.toLowerCase().includes('anchor')) hooks.push('practical');
                if (neuralText.toLowerCase().includes('narrative') || neuralText.toLowerCase().includes('historical')) hooks.push('narrative');
                if (neuralText.toLowerCase().includes('model') || neuralText.toLowerCase().includes('visualization')) hooks.push('visual');

                return hooks.length > 0 ? hooks : ['mathematical', 'visual', 'practical'];
            }

            createMission(challenge) {
                const missionId = 'SECURE_' + Date.now();
                const sector = this.detectSector(challenge);
                const difficulty = this.assessDifficulty(challenge);
                
                return {
                    id: missionId,
                    challenge: challenge,
                    sector: sector,
                    difficulty: difficulty,
                    timestamp: new Date().toISOString(),
                    status: 'active',
                    xpPotential: this.calculateXP(difficulty),
                    secureMode: true,
                    byokGenerated: true
                };
            }

            detectSector(challenge) {
                const keywords = {
                    'Science': ['biology', 'chemistry', 'physics', 'quantum', 'molecular', 'genetic', 'evolution', 'ecology', 'neuroscience', 'astronomy'],
                    'Technology': ['AI', 'machine learning', 'blockchain', 'cybersecurity', 'cloud', 'IoT', 'robotics', 'programming', 'software'],
                    'Engineering': ['aerospace', 'biomedical', 'civil', 'mechanical', 'electrical', 'chemical', 'systems', 'design', 'optimization'],
                    'Mathematics': ['calculus', 'linear algebra', 'statistics', 'topology', 'number theory', 'differential equations', 'probability']
                };
                
                const lowerChallenge = challenge.toLowerCase();
                for (const [sector, words] of Object.entries(keywords)) {
                    if (words.some(word => lowerChallenge.includes(word))) {
                        return sector;
                    }
                }
                return 'Science';
            }

            assessDifficulty(challenge) {
                const length = challenge.length;
                const advancedWords = ['quantum', 'molecular', 'differential', 'topology', 'optimization', 'algorithm', 'neural', 'genetic'];
                const hasAdvancedWords = advancedWords.some(word => challenge.toLowerCase().includes(word));
                
                if (length > 250 || hasAdvancedWords) return 'Admiral';
                if (length > 150) return 'Commander';
                if (length > 75) return 'Officer';
                return 'Cadet';
            }

            calculateXP(difficulty) {
                const xpMap = {
                    'Cadet': 25,    // Bonus XP for secure mode
                    'Officer': 40,
                    'Commander': 65,
                    'Admiral': 100
                };
                return xpMap[difficulty] || 25;
            }

            extractTopicFromChallenge(challenge) {
                const words = challenge.toLowerCase().split(' ');
                const stopWords = ['i', 'want', 'to', 'understand', 'how', 'what', 'why', 'explain', 'teach', 'learn'];
                const meaningfulWords = words.filter(word => !stopWords.includes(word) && word.length > 3);
                return meaningfulWords.slice(0, 3).join(' ') || 'advanced concept';
            }

            generateFallbackSeed(mission) {
                const topic = this.extractTopicFromChallenge(mission.challenge);
                
                return {
                    mission_id: mission.id,
                    title: `🔑 Secure Enhanced: ${topic} 🔑`,
                    difficulty: mission.difficulty,
                    xp_value: mission.xpPotential,
                    secureGenerated: false,
                    modules: [
                        {
                            type: "concept_introduction",
                            content: `Let's explore ${topic} using our secure enhanced system. This ${mission.difficulty.toLowerCase()}-level challenge builds advanced understanding through systematic analysis.`,
                            understanding_check: "What fundamental principles drive this system's behavior?"
                        },
                        {
                            type: "core_knowledge", 
                            content: `The advanced concepts of ${topic} involve mathematical modeling, experimental validation, and theoretical frameworks. Understanding these gives you research-level insights.`,
                            understanding_check: "How would you design experiments to test these theoretical predictions?"
                        },
                        {
                            type: "practical_application",
                            content: `Apply your knowledge through advanced research methods: mathematical modeling, computer simulations, experimental design, and peer collaboration.`,
                            understanding_check: "What innovative applications could you develop based on these principles?"
                        }
                    ],
                    next_steps: [
                        `Research cutting-edge developments in ${topic}`,
                        'Join academic research communities',
                        'Develop mathematical models',
                        'Design original experiments',
                        'Contribute to scientific literature'
                    ],
                    neural_pattern: {
                        retention_hooks: ['mathematical', 'experimental', 'theoretical'],
                        integration_points: [mission.sector.toLowerCase()],
                        difficulty_progression: mission.difficulty,
                        brain_ready: true
                    }
                };
            }

            displayLearningSeed(seed) {
                const display = document.getElementById('seed-content');
                if (!display) return;

                const securityBadge = seed.secureGenerated ? 
                    '<span class="byok-secured">🔑 BYOK SECURED 🔑</span>' : 
                    '<span class="difficulty">ENHANCED SIMULATION</span>';

                display.innerHTML = `
                    <div class="learning-seed-header">
                        <h4>${seed.title}</h4>
                        <div class="seed-meta">
                            <span class="difficulty">Difficulty: ${seed.difficulty}</span>
                            <span class="xp-potential">XP: +${seed.xp_value}</span>
                            ${securityBadge}
                        </div>
                    </div>
                    
                    ${seed.modules.map((module, index) => `
                        <div class="seed-module" data-module="${index}">
                            <h5>${module.type.replace('_', ' ')}</h5>
                            <p>${module.content}</p>
                            <div class="understanding-check">
                                <strong>🔑 Secure Check:</strong> ${module.understanding_check}
                            </div>
                        </div>
                    `).join('')}
                    
                    <div class="next-steps">
                        <h5>🔑 Secure Next Steps</h5>
                        <ul>
                            ${seed.next_steps.map(step => `<li>${step}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <button class="complete-btn" onclick="window.secureVoltron.completeMission('${seed.mission_id}')">
                            🔑 Complete Secure Mission (+${seed.xp_value} XP)
                        </button>
                    </div>
                `;
            }

            showProcessingState(mission) {
                const display = document.getElementById('seed-content');
                if (!display) return;

                display.innerHTML = `
                    <div class="processing">
                        <div style="font-size: 28px; margin-bottom: 20px;">🔑 Secure Claude Processing... 🔑</div>
                        <div class="secure-spinner"></div>
                        <div style="color: #00ff88; margin-bottom: 10px; font-size: 18px;">Mission: ${mission.sector} Challenge</div>
                        <div style="color: #888;">Difficulty: ${mission.difficulty} | XP Potential: +${mission.xpPotential}</div>
                        <div style="margin-top: 20px; color: #4a90e2; font-size: 16px;">🔑 Secure analysis: "${mission.challenge}"</div>
                        <div style="margin-top: 10px; color: #00ff88;">🛡️ Your key, your control, your privacy...</div>
                    </div>
                `;
            }

            completeMission(missionId) {
                const seed = this.learningSeeds.find(s => s.mission_id === missionId);
                if (!seed) return;

                this.userProgress.totalXP += seed.xp_value;
                this.userProgress.missionsComplete += 1;
                this.userProgress.conceptsMastered.push(seed.title);
                
                this.checkRankProgression();
                
                const message = seed.secureGenerated ? 
                    `🔑 SECURE MISSION COMPLETE! +${seed.xp_value} XP earned! 🔑` :
                    `⚡ ENHANCED MISSION COMPLETE! +${seed.xp_value} XP earned! ⚡`;
                    
                this.showToast(message, 'success');
                this.updateProgressDisplay();
                this.saveUserProgress();
                
                console.log(`🔑 Secure Mission ${missionId} completed! Total XP: ${this.userProgress.totalXP}`);
            }

            checkRankProgression() {
                const ranks = ['Cadet', 'Ensign', 'Lieutenant', 'Commander', 'Captain', 'Fleet Admiral'];
                const xpThresholds = [0, 75, 225, 450, 750, 1500]; // Higher thresholds for secure XP
                
                const currentRankIndex = ranks.indexOf(this.userProgress.rank);
                const nextRankIndex = currentRankIndex + 1;
                
                if (nextRankIndex < ranks.length && this.userProgress.totalXP >= xpThresholds[nextRankIndex]) {
                    this.userProgress.rank = ranks[nextRankIndex];
                    this.showToast(`🎖️ SECURE PROMOTION! You are now ${this.userProgress.rank}! 🔑`, 'promotion');
                }
            }

            updateProgressDisplay() {
                const progressContent = document.getElementById('progress-content');
                if (!progressContent) return;

                progressContent.innerHTML = `
                    <div style="display: flex; gap: 30px; justify-content: center; flex-wrap: wrap;">
                        <div style="text-align: center; padding: 15px; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
                            <div style="font-size: 2em; color: #00ff88;">${this.userProgress.rank}</div>
                            <div style="color: #888;">Current Rank</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
                            <div style="font-size: 2em; color: #4a90e2;">${this.userProgress.totalXP} XP</div>
                            <div style="color: #888;">Total Experience</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(74, 144, 226, 0.1); border-radius: 8px;">
                            <div style="font-size: 2em; color: #ff6b35;">${this.userProgress.secureSessions}</div>
                            <div style="color: #888;">Secure Sessions</div>
                        </div>
                    </div>
                `;
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                const bgColor = {
                    'success': '#00ff88',
                    'warning': '#ffaa00', 
                    'promotion': '#ff00aa',
                    'error': '#ff6b35',
                    'info': '#4a90e2'
                }[type] || '#4a90e2';
                
                const textColor = (type === 'success' || type === 'warning') ? '#000' : '#fff';
                
                toast.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10000;
                    background: ${bgColor}; color: ${textColor};
                    padding: 15px 20px; border-radius: 8px; font-weight: bold;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideIn 0.3s ease;
                    max-width: 350px; font-size: 14px;
                `;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            }

            loadUserProgress() {
                console.log('📊 Secure User Progress Loaded:', this.userProgress);
            }

            saveUserProgress() {
                console.log('💾 Secure Progress Saved - Rank:', this.userProgress.rank, 'XP:', this.userProgress.totalXP, 'Sessions:', this.userProgress.secureSessions);
            }
        }

        // 🔑 BYOK SECURE FUNCTIONS
        function setClaudeKey() {
            const keyInput = document.getElementById('claude-key-input');
            const key = keyInput.value.trim();
            
            if (!key) {
                window.secureVoltron.showToast('Please enter your Claude API key', 'warning');
                return;
            }
            
            if (!window.secureVoltron.validateKeyFormat(key)) {
                window.secureVoltron.showToast('Invalid Claude API key format. Must start with sk-ant-api03-', 'error');
                return;
            }
            
            // Store securely in localStorage
            localStorage.setItem('user_claude_key', key);
            window.userClaudeKey = key;
            
            // Clear input
            keyInput.value = '';
            
            // Enable mission form
            window.secureVoltron.enableMissionForm();
            window.secureVoltron.updateApiStatus('✅ Claude API key set successfully and stored securely', 'success');
            window.secureVoltron.claudeStatus = 'READY';
            
            console.log('🔑 Claude API key set securely');
            window.secureVoltron.showToast('🔑 Claude API key secured! Ready for missions!', 'success');
        }

        async function testClaudeKey() {
            if (!window.userClaudeKey) {
                window.secureVoltron.showToast('Please set your Claude API key first', 'warning');
                return;
            }
            
            window.secureVoltron.updateApiStatus('🧪 Testing Claude API connection...', 'warning');
            
            try {
                const testPrompt = 'Respond with exactly: "VOLTRON BYOK TEST SUCCESSFUL"';
                const response = await window.secureVoltron.callSecureClaudeAPI(testPrompt);
                
                if (response && response.includes('VOLTRON BYOK TEST SUCCESSFUL')) {
                    window.secureVoltron.updateApiStatus('✅ Claude API test successful! Ready for secure missions.', 'success');
                    window.secureVoltron.showToast('🧪 Claude API test successful!', 'success');
                } else {
                    window.secureVoltron.updateApiStatus('⚠️ Claude responded but format unexpected. Key may work for missions.', 'warning');
                }
            } catch (error) {
                console.error('Claude API test failed:', error);
                if (error.message.includes('Invalid API key')) {
                    window.secureVoltron.updateApiStatus('❌ Invalid API key. Please check and re-enter.', 'error');
                } else if (error.message.includes('Rate limit')) {
                    window.secureVoltron.updateApiStatus('⚠️ Rate limit hit. Key is valid but wait before testing again.', 'warning');
                } else {
                    window.secureVoltron.updateApiStatus(`❌ Test failed: ${error.message}`, 'error');
                }
            }
        }

        function clearClaudeKey() {
            if (confirm('Are you sure you want to remove your Claude API key? This will disable AI-powered missions.')) {
                localStorage.removeItem('user_claude_key');
                delete window.userClaudeKey;
                
                document.getElementById('claude-key-input').value = '';
                window.secureVoltron.disableMissionForm();
                window.secureVoltron.updateApiStatus('🗑️ Claude API key removed. Set a new key to continue.', 'warning');
                window.secureVoltron.claudeStatus = 'NO_KEY';
                
                console.log('🔑 Claude API key cleared');
                window.secureVoltron.showToast('🗑️ Claude API key removed securely', 'warning');
            }
        }

        // 🔑 INITIALIZE SECURE VOLTRON
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ FOUNDATION: Secure mission form found and protected');
            
            window.secureVoltron = new SecureVoltronBYOK();
            window.hexMindBridge = window.secureVoltron; // Backward compatibility
            
            console.log('🔑 HexMind Voltron BYOK Secure - FULLY OPERATIONAL! 🔑');
        });
    </script>
</body>
</html>
